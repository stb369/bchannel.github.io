# ãƒªãƒã‚¸ãƒˆãƒª: bchannel.github.io
# ãƒ•ã‚¡ã‚¤ãƒ«å: .github/workflows/main-deploy.yml
name: Full Unity & Vite Deployment

on:
  repository_dispatch: # ğŸ’¡ å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å—ã‘ä»˜ã‘ã‚‹
    types: [start-full-deploy]
  workflow_dispatch: # ğŸ’¡ æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- 0. ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®æº–å‚™ ---
      - name: Checkout bchannel.github.io (Target)
        uses: actions/checkout@v4
        with:
          path: deploy_target
          
      # --- 1. Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ ---
      - name: Checkout bpb2-system (Source 1)
        uses: actions/checkout@v4
        with:
          repository: stb369/BpB2-System
          path: BpB2-System
          token: ${{ secrets.PAGES_TOKEN }} # PATã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚‚å¯èƒ½

      - name: Cache Unity
        uses: actions/cache@v4
        with:
          path: BpB2-System/Library
          key: ${{ runner.os }}-unity-${{ hashFiles('bpb2-system/Assets/**') }}

      - name: Build Unity WebGL
        uses: game-ci/unity-builder@v4
        with:
          # ğŸ’¡ Unityãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„
          unityVersion: 6000.2.14f1 
          targetPlatform: WebGL
          # ğŸ’¡ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          buildPath: ./BpB2-System/Build/WebGL
          
      # --- 2. Vite+React ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ ---
      - name: Checkout bpb2-vitereact (Source 2)
        uses: actions/checkout@v4
        with:
          repository: stb369/bpb2-vitereact
          path: bpb2-vitereact
          token: ${{ secrets.PAGES_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: true
          
      - name: Build Vite+React
        run: pnpm run build
        working-directory: ./bpb2-vitereact

      # --- 3. æˆæœç‰©ã®çµ±åˆã¨ãƒãƒ¼ã‚¸ ---
      # ğŸ’¡ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™
      - name: Prepare Deployment Directory
        run: |
          mkdir -p ./deploy_target/bpb2
          
      # 3.1. Unity ãƒ“ãƒ«ãƒ‰æˆæœç‰© (æ¯ä½“) ã‚’ã‚³ãƒ”ãƒ¼
      - name: Copy Unity Build to Target
        run: cp -r ./BpB2-System/Build/WebGL/* ./deploy_target/bpb2/

      # 3.2. Vite ãƒ“ãƒ«ãƒ‰ã® assets ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¸Šæ›¸ãã‚³ãƒ”ãƒ¼
      - name: Copy Vite Assets (Overwrite)
        run: cp -r ./bpb2-vitereact/bpb2/assets ./deploy_target/bpb2/

      # 3.3. HTML ãƒãƒ¼ã‚¸ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆæŒ¿å…¥ (Node.jsã§å®Ÿè¡Œ)
      - name: Run HTML Merge Script
        run: node ./bpb2-vitereact/scripts/merge_unity_vite.js
        # ğŸ’¡ merge_unity_vite.js ãŒ './bpb2-vitereact/dist/index.html' ã¨
        #    './deploy_target/bpb2/index.html' ã‚’å‡¦ç†ã™ã‚‹ã‚ˆã†ã«ãƒ‘ã‚¹ã‚’èª¿æ•´ã™ã‚‹ã‹ã€
        #    ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¸€æ™‚çš„ã«ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        #    ã“ã“ã§ã¯ã€merge_unity_vite.js ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å‡¦ç†ã™ã‚‹ã¨ä»®å®šã€‚
        working-directory: ./bpb2-vitereact
        env:
          # ğŸ’¡ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ç’°å¢ƒå¤‰æ•°ã§ãƒ‘ã‚¹ã‚’æ¸¡ã™
          UNITY_BUILD_PATH: ../deploy_target/bpb2/index.html
          VITE_BUILD_PATH: ./bpb2/index.html

      # --- 4. GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ ---
      - name: Deploy to GitHub Pages (bpb2 subdirectory)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.PAGES_TOKEN }}
          publish_dir: ./deploy_target # bchannel.github.io ã®ãƒ«ãƒ¼ãƒˆ
          destination_dir: bpb2 # bchannel.github.io/bpb2 ã«ãƒ‡ãƒ—ãƒ­ã‚¤
